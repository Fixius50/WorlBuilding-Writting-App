<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../css/ventanaProyectos.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <title>Ventana Proyectos</title>
</head>
<body>
    <div class="panel0">
        <!-- Aqu√≠ entra el men√∫ con opciones, 
         de las cuales te llevan a ventanas de distintas cosas. -->
        <div class="top">
            <div class="menu-desplegable">   
                <b>MEN√ö</b>
                <div class="content">
                    <!-- Hacer que la letra se esconda hasta que se pase el rat√≥n por encima.
                    Luego hacer que se quede el √∫ltimo recuadro del cual se haya puesto el rat√≥n y no se vaya--> 
                    <button class="option" id="bt1" onclick="abrirVentanaCreacion()">Generar objetos</button>
                    <!--
                    <button class="option" id="bt1" onclick="">Importar (proximamente) </button>
                    <button class="option" id="bt1" onclick="">Exportar (proximamente) </button>
                    <button class="option" id="bt1" onclick="">Wiki (proximamente) </button>
                    <button class="option" id="bt1" onclick="">Apuntes (proximamente) </button> 
                    -->
                    <button class="option" id="bt1" onclick="abrirVentanaAjustes()">Ajustes proyecto</button>
                    <button class="option" id="bt1" onclick="abrirVentanaMenuInicial()">P√°gina inicial </button>
                </div>
                <b class="simbolo">&dArr;</b>
            </div>
            <!-- Aqu√≠ entra algo que ya ver√© que hacer. A lo mejor un gif animado o
             la autor√≠a con el nombre del proyecto. M√°s tarde se editar√° para mejorarlo.-->
            <div class="infoTop">
                <header class="header-top"><!-- Aqu√≠ va el nombre del proyecto y el tipo -->
                    <b id="nombre-proyecto" oninput="mostarInfoProyecto()"></b>
                </header>
                
                <nav class="navTop">
                    <!-- Esto son pesta√±as que se despliegan. Los nombres indican cosas generales.
                     Ej: la pesta√±a "Construcci√≥n" agrega dentro opciones relacionadas a la puesta
                     de las cosas/fichas (personajes/objetos/lugares, etc...), como las subopciones:
                     - Agregar
                     - Editar
                     - Eliminar -->
                    <header class="construccion">Construcci√≥n</header>
                    <header class="estado">Estado</header>
                    <header class="nv">Eliminar</header>
                    <header class="nv">Acciones</header>
                    <header class="nv">Decisiones</header>
                </nav>
            </div>
        </div>
        <div class="area-central">
            <section class="objects">
                <div class="objects-container">
                    <!-- Entidades Individuales -->
                    <div class="object-category">
                        <div class="category-header">
                            <span class="category-icon">üë§</span>
                            <span class="category-name">Personajes</span>
                            <span class="category-count" id="count-entidades-individuales">0</span>
                        </div>
                        <div class="object-list" id="list-entidades-individuales">
                            <!-- Los elementos se cargar√°n din√°micamente -->
                        </div>
                    </div>
                    
                    <!-- Entidades Colectivas -->
                    <div class="object-category">
                        <div class="category-header">
                            <span class="category-icon">üèõÔ∏è</span>
                            <span class="category-name">Organizaciones</span>
                            <span class="category-count" id="count-entidades-colectivas">0</span>
                        </div>
                        <div class="object-list" id="list-entidades-colectivas">
                            <!-- Los elementos se cargar√°n din√°micamente -->
                        </div>
                    </div>
                    
                    <!-- Construcciones -->
                    <div class="object-category">
                        <div class="category-header">
                            <span class="category-icon">üè∞</span>
                            <span class="category-name">Construcciones</span>
                            <span class="category-count" id="count-construcciones">0</span>
                        </div>
                        <div class="object-list" id="list-construcciones">
                            <!-- Los elementos se cargar√°n din√°micamente -->
                        </div>
                    </div>
                    
                    <!-- Zonas -->
                    <div class="object-category">
                        <div class="category-header">
                            <span class="category-icon">üó∫Ô∏è</span>
                            <span class="category-name">Zonas</span>
                            <span class="category-count" id="count-zonas">0</span>
                        </div>
                        <div class="object-list" id="list-zonas">
                            <!-- Los elementos se cargar√°n din√°micamente -->
                        </div>
                    </div>
                    
                    <!-- Efectos -->
                    <div class="object-category">
                        <div class="category-header">
                            <span class="category-icon">‚ú®</span>
                            <span class="category-name">Efectos</span>
                            <span class="category-count" id="count-efectos">0</span>
                        </div>
                        <div class="object-list" id="list-efectos">
                            <!-- Los elementos se cargar√°n din√°micamente -->
                        </div>
                    </div>
                </div>
                <div class="map-info">
                    <p><strong>Controles:</strong></p>
                    <ul>
                        <li><strong>Mouse:</strong> Arrastrar para mover, rueda para zoom</li>
                        <li><strong>Teclado:</strong> Flechas para mover, +/- para zoom, 0 para reset</li>
                    </ul>
                </div>
                <!-- Esto es el cabecero que sale con los botones de arriba del mapa -->
                <div class="map-header">
                    <div class="map-controls">
                        <button class="map-btn" onclick="resetMapView()" title="Resetear vista">
                            <i class="fas fa-home"></i>
                        </button>
                        <button class="map-btn" onclick="zoomInMap()" title="Zoom +">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button class="map-btn" onclick="zoomOutMap()" title="Zoom -">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <button class="map-btn" onclick="toggleCoordinates()" title="Mostrar/Ocultar coordenadas">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                    </div>
                </div>
                <button class="reload-btn" onclick="reloadProjectData()" title="Recargar datos">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </section>
            <section class="ground">
                <div class="map-container">
                    <div id="infinite-map-container" class="map-area">
                        <!-- El mapa se cargar√° aqu√≠ -->
                    </div>
                </div>
            </section>
        </div>
    </div>
</body>

<!-- Scripts necesarios para el mapa infinito y la carga de datos del proyecto -->
<script src="../js/esquemas/InfiniteMap.js"></script>
<script src="../js/esquemas/ProjectDataLoader.js"></script>

<!-- En ProjectDataLoader se cargan los nodos que van a ser arrastrados al mapa. 
    Mirar ah√≠ y modificar los estilos.
    PD: hacer unos arrastrables para cuando no haya proyecto activo.
-->

<script>
    let nombreProyectoGlobal = null;
    let infiniteMap = null;
    let projectDataLoader = null;

    function abrirVentanaCreacion() {
        if (nombreProyectoGlobal) {
            window.location.href = `/html/ventanaCreacion.html?proyecto=${encodeURIComponent(nombreProyectoGlobal)}`;
        }
    }

    function abrirVentanaAjustes() {
        if (nombreProyectoGlobal) {
            window.location.href = `/html/ventanaAjustes.html?proyecto=${encodeURIComponent(nombreProyectoGlobal)}`;
        }
    }

    function abrirVentanaMenuInicial() {
        if (nombreProyectoGlobal) {
            window.location.href = `../menuInicialLog.html`;
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Primero obtenemos el proyecto activo
            const resProyecto = await fetch('/api/proyectos/activo');
            console.log('Respuesta del servidor (proyecto activo):', resProyecto.status);
            
            if (!resProyecto.ok) {
                throw new Error("No hay proyecto activo");
            }

            const proyecto = await resProyecto.json();
            console.log('Datos del proyecto:', proyecto);

            // Guardamos el nombre del proyecto y actualizamos la UI
            nombreProyectoGlobal = proyecto.nombre;
            document.getElementById("nombre-proyecto").textContent = `${proyecto.nombre} ( -${proyecto.enfoque}- )`;

            // Luego cargamos la configuraci√≥n
            const resConfig = await fetch('/api/config');
            const config = await resConfig.json();
            console.log('Configuraci√≥n cargada:', config);

            // Inicializamos el mapa y el cargador de datos solo si tenemos un proyecto activo
            initializeInfiniteMap();
            
            // Esperamos un momento antes de inicializar el cargador de datos
            setTimeout(() => {
                initializeProjectDataLoader();
                // Cargamos los datos del proyecto
                if (projectDataLoader) {
                    projectDataLoader.loadProjectData().then(() => {
                        console.log('Datos del proyecto cargados correctamente');
                    }).catch(error => {
                        console.error('Error al cargar datos del proyecto:', error);
                    });
                }
            }, 500);

        } catch (error) {
            console.error('Error al inicializar la p√°gina:', error);
            document.getElementById("nombre-proyecto").textContent = "Sin proyecto activo";
            // A√∫n as√≠ inicializamos el mapa para poder mostrar la interfaz
            initializeInfiniteMap();
        }
    });

    // ===== FUNCIONES DEL MAPA INFINITO =====

    function initializeInfiniteMap() {
        // Esperar a que el DOM est√© completamente cargado
        setTimeout(() => {
            const container = document.getElementById('infinite-map-container');
            if (container) {
                infiniteMap = new InfiniteMap('infinite-map-container', {
                    gridSize: 100,
                    gridColor: '#e0e0e0',
                    gridOpacity: 0.3,
                    backgroundColor: '#f8f9fa',
                    zoomLevel: 1,
                    minZoom: 0.1,
                    maxZoom: 5,
                    showCoordinates: true,
                    coordinateColor: '#666'
                });
                
                console.log('üó∫Ô∏è Mapa infinito cargado en ventana de proyectos');
                
                // Cargar marcadores de ejemplo despu√©s de un breve delay
                setTimeout(() => {
                    loadProjectMarkers();
                }, 500);
            } else {
                console.error('‚ùå Contenedor del mapa no encontrado');
            }
        }, 100);
    }

    function resetMapView() {
        if (infiniteMap) {
            infiniteMap.resetView();
        }
    }

    function zoomInMap() {
        if (infiniteMap) {
            infiniteMap.zoomIn();
        }
    }

    function zoomOutMap() {
        if (infiniteMap) {
            infiniteMap.zoomOut();
        }
    }

    function toggleCoordinates() {
        if (infiniteMap) {
            infiniteMap.config.showCoordinates = !infiniteMap.config.showCoordinates;
            infiniteMap.render();
        }
    }


    // ===== FUNCIONES DEL CARGADOR DE DATOS =====

    function initializeProjectDataLoader() {
        projectDataLoader = new ProjectDataLoader();
        
        // Cargar datos del proyecto despu√©s de un breve delay
        setTimeout(() => {
            projectDataLoader.loadProjectData();
        }, 500);
        
        console.log('üì¶ Cargador de datos del proyecto inicializado');
    }

    // Funci√≥n para recargar datos del proyecto
    function reloadProjectData() {
        if (!projectDataLoader) return;
        
        const reloadBtn = document.querySelector('.reload-btn');
        if (reloadBtn) {
            reloadBtn.classList.add('loading');
        }
        
        projectDataLoader.reload().then(() => {
            if (reloadBtn) {
                reloadBtn.classList.remove('loading');
            }
        }).catch(() => {
            if (reloadBtn) {
                reloadBtn.classList.remove('loading');
            }
        });
    }

    // Funci√≥n para cargar marcadores desde el proyecto (ahora usa datos reales)
    function loadProjectMarkers() {
        if (!nombreProyectoGlobal || !projectDataLoader) return;
        
        // Los marcadores se cargar√°n autom√°ticamente cuando se arrastren elementos
        console.log('üìç Los marcadores se cargar√°n al arrastrar elementos al mapa');
    }
</script>
</html>